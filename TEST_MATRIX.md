# Tree Health — Полный чек-лист приёмки (CPU/GPU)

## I. Файлы и переменные
- [ ] В `./weights` лежат веса сегментации растений и дефектов (или используются дефолтные YOLO).
- [ ] В `./models/species/` лежат: `model_ts.pt`, `classes.json`, `species_ru_map.json`.
- [ ] `.env` содержит корректные пути и `DEVICE=cpu` для CPU или `DEVICE=cuda:0` для GPU.
- [ ] В `docker-compose.(cpu|gpu).yml` смонтированы `./weights`, `./rules`, `./models`, `./data`.
- [ ] В `docker-compose.gpu.yml` задано `gpus: all` (если не Swarm).
- [ ] В `species_infer.py` используется `config.DEVICE`, нет жёстких `.cuda()`.

## II. Сборка и запуск
- [ ] Образ собирается без ошибок (CPU/GPU).
- [ ] Контейнер поднимается, `curl /health` → `{"status":"ok"}` в течение 30 секунд.
- [ ] Логи без traceback'ов на старте.

## III. Инференс (E2E)
- [ ] POST `/infer` с тест-картинкой возвращает 200 и JSON с ключами: `request_id`, `overlay_path`, `report_json_path`, `plants`, `defects`.
- [ ] В `plants[0]` присутствуют поля `species` или `species_russian/latin/conf` (если `SPECIES_TS` задан).
- [ ] `overlay_path` указывает на сохранённый файл (может быть только внутри контейнера).
- [ ] Внутри `report_json_path` корректные поля и RLE-маски (не пустые строки, если есть сегментация).
- [ ] CSV-файлы (`plants.csv`, `defects.csv`) создаются в каталоге выгрузки.

## IV. Регрессии и углы
- [ ] Некартинка (`.txt`) → 400/500 с понятным сообщением, сервис не умирает.
- [ ] Большой вход (≥ 4000×3000) проходит без `broadcast`-ошибок (маски ресайзятся).
- [ ] Пустая сцена (нет растений) не падает, возвращает пустые массивы.
- [ ] Включённый `PLANT_FALLBACK=1` даёт растения на «зелёной картинке» даже без YOLO-весов.

## V. Производительность
- [ ] Время ответа на 1 мегапиксель ≤ N секунд на CPU, ≤ M секунд на GPU (записать фактические).
- [ ] Память не растёт от запроса к запросу (нет утечек).

## VI. Оффлайн-сервер
- [ ] Сервис стартует без доступа к интернету (нет попыток `torch.hub`/скачиваний).

## VII. Хенд-офф
- [ ] В README описано: где положить веса, как запустить CPU/GPU, какой эндпоинт дёргать.
- [ ] При смене весов не требуется пересборка образа — только перезапуск контейнера.
